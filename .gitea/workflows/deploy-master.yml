name: Terraform Deploy VM
on: [push]

jobs:
  terraform-deploy:
    runs-on: [ubuntu-22.04]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SSH Key
        run: |
          apk add --no-cache openssh-client
          mkdir -p /root/.ssh
          ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N "" -q
          echo "SSH Public Key:"
          cat /root/.ssh/id_ed25519.pub

      - name: Configure Terraform Local Cache
        run: |
          cat > /root/.terraformrc << 'EOF'
provider_installation {
  filesystem_mirror {
    path    = "/root/.terraform.d/plugins"
    include = ["registry.terraform.io/*/*"]
  }
  direct {
    exclude = ["registry.terraform.io/*/*"]
  }
}
